montageDefine("c50fb48","runtime/runtime-tf-loader",{dependencies:["runtime/dependencies/gl-matrix","runtime/glTF-parser","runtime/resource-description","runtime/technique","runtime/pass","runtime/pass","runtime/pass","runtime/glsl-program","runtime/glTF-material","runtime/mesh","runtime/glTF-node","runtime/primitive","runtime/projection","runtime/camera","runtime/skin","runtime/glTF-scene","runtime/transform","runtime/animation","runtime/animation-manager"],factory:function(e,t,r){e("runtime/dependencies/gl-matrix");var n=e("runtime/glTF-parser").glTFParser,i=e("runtime/resource-description").ResourceDescription,s=e("runtime/technique").Technique,a=e("runtime/pass").ProgramPass,o=(e("runtime/pass").Pass,e("runtime/pass").ScenePass,e("runtime/glsl-program").GLSLProgram),c=e("runtime/glTF-material").glTFMaterial,u=e("runtime/mesh").Mesh,h=e("runtime/glTF-node").glTFNode,l=e("runtime/primitive").Primitive,m=e("runtime/projection").Projection,d=e("runtime/camera").Camera,p=e("runtime/skin").Skin,f=e("runtime/glTF-scene").glTFScene,v=e("runtime/transform").Transform,y=e("runtime/animation").Animation,g=e("runtime/animation-manager").AnimationManager;t.RuntimeTFLoader=Object.create(n,{_materials:{writable:!0,value:null},_scenes:{writable:!0,value:null},_animations:{writable:!0,value:null},totalBufferSize:{value:0,writable:!0},handleBuffer:{value:function(e,t,r){var n=Object.create(i).init(e,t);return n.id=e,this.storeEntry(e,n,t),this.totalBufferSize+=t.byteLength,t.type="arraybuffer",!0}},handleBufferView:{value:function(e,t,r){var n=Object.create(i).init(e,t);n.id=e;var s=this.getEntry(n.description.buffer);return t.type="ArrayBufferView",n.buffer=s,this.storeEntry(e,n,t),!0}},handleShader:{value:function(e,t,r){var n=Object.create(i).init(e,t);return n.id=e,n.type="shader",this.storeEntry(e,n,t),!0}},handleProgram:{value:function(e,t,r){var n=Object.create(i).init(e,t);n.id=e,n.type="program";var s=this.getEntry(n.description.vertexShader),a=this.getEntry(n.description.fragmentShader);return n[o.VERTEX_SHADER]=s.entry,n[o.FRAGMENT_SHADER]=a.entry,this.storeEntry(e,n,t),!0}},handleImage:{value:function(e,t,r){var n=t.path,s=Object.create(i).init(n,{path:n});return s.type="image",this.storeEntry(e,s,t),!0}},handleVideo:{value:function(e,t,r){var n=t.path,s=Object.create(i).init(n,{path:n});return s.type="video",this.storeEntry(e,s,t),!0}},handleTechnique:{value:function(e,t,r){var n=Object.create(s);n.id=e;var i=this.storeEntry(e,n,t),o=t.pass;n.passName=o;var c=t.passes;if(!c)return console.log("ERROR: technique does not contain pass"),!1;var u={},h=Object.keys(t.passes);return h.forEach(function(e){var t=c[e],r=t.instanceProgram;if(!r)return console.log("ERROR: A Pass with type=program must have a program property"),!1;var n=(new a).init();n.id=i+"_"+o,n.instanceProgram=t.instanceProgram,n.instanceProgram.program=this.getEntry(r.program).entry,n.states=t.states,u[e]=n},this),n.parameters=t.parameters,n.passes=u,!0}},handleMaterial:{value:function(e,t,r){var n=Object.create(c).init(e);this.storeEntry(e,n,t);var i=t.instanceTechnique,s=i.values;n.name=t.name;var a=this.getEntry(i.technique);if(!a)return console.log("ERROR: invalid file, cannot find referenced technique:"+t.technique),!1;n.technique=a.entry;var o=n.technique.parameters;return n.parameters=JSON.parse(JSON.stringify(o)),s&&s.forEach(function(e){var t=o[e.parameter];if(t){var r=null;switch(t.type){case"SAMPLER_CUBE":case"SAMPLER_2D":var i=this.getEntry(e.value);i?(e.value=i.entry,r=e):console.log("ERROR: can't find texture:"+e.value);break;default:r=e}}n.parameters[e.parameter]=r},this),this._materials||(this._materials=[]),this._materials.push(n),!0}},handleLight:{value:function(e,t,r){return!0}},handleAttribute:{value:function(e,t,r){var n=this.getEntry(t.bufferView);t.bufferView=n.entry,t.byteOffset||(t.byteOffset=0),this.storeEntry(e,t,t)}},handleIndices:{value:function(e,t,r){t.id=e;var n=this.getEntry(t.bufferView);t.bufferView=n.entry,this.storeEntry(e,t,t)}},handleMesh:{value:function(e,t,r){var n=Object.create(u).init();n.id=e,n.name=t.name;var i=!1,s=t.extensions;s&&(s["won-compression"]&&(i=!0,n.compression=s["won-compression"],n.compression.type="won-compression",n.compression.compressedData.bufferView=this.getEntry(n.compression.compressedData.bufferView).entry,n.compression.compressedData.id=e+"_compressedData"),s["Open3DGC-compression"]&&(i=!0,n.compression=s["Open3DGC-compression"],n.compression.type="Open3DGC-compression",n.compression.compressedData.bufferView=this.getEntry(n.compression.compressedData.bufferView).entry,n.compression.compressedData.id=e+"_compressedData")),this.storeEntry(e,n,t);var a=t[u.PRIMITIVES];if(!a)return console.log("MISSING_PRIMITIVES for mesh:"+e),!1;for(var o=0;o<a.length;o++){var c=a[o];if("TRIANGLES"===c.primitive){var h=Object.create(l).init(),m=this.getEntry(c.material);h.material=m.entry,n.primitives.push(h);var d=c.semantics,p=Object.keys(d);p.forEach(function(e){var t=d[e],r=this.getEntry(t);h.addVertexAttribute({semantic:e,attribute:r.entry})},this);var f=c.indices,v=this.getEntry(f);h.indices=v.entry}}return!0}},handleCamera:{value:function(e,t,r){var n=Object.create(d).init();n.id=e,this.storeEntry(e,n,t);var i=Object.create(m);return i.initWithDescription(t),n.projection=i,!0}},handleLight:{value:function(e,t,r){return!0}},buildNodeHirerachy:{value:function(e){var t=e.entry,r=e.description.children;r&&r.forEach(function(e){var r=this.getEntry(e),n=r.entry;null==n.parent?t.children.push(n):t.children.push(n.copy()),this.buildNodeHirerachy(r)},this)}},resolveParameterSources:{value:function(){this._materials&&this._materials.forEach(function(e){if(e.parameters){var t=Object.keys(e.parameters);t.forEach(function(t){var r=e.parameters[t];r&&r.source&&(r.source=this.getEntry(r.source).entry)},this)}},this)}},buildSkeletons:{value:function(e){if(e.instanceSkin){var t=e.instanceSkin.skin;if(t){e.instanceSkin.skeletons.forEach(function(e){var r=this.getEntry(e);if(r){var n=r.entry,i=t.jointsIds,s=[];i.forEach(function(t){var r=n.nodeWithJointID(t);r?s.push(r):console.log("WARNING: jointId:"+t+" cannot be found in skeleton:"+e)},this),t.nodesForSkeleton[e]=s}},this);var r=[];e.instanceSkin.sources.forEach(function(e){var t=this.getEntry(e);t&&r.push(t.entry)},this),t.sources=r}}var n=e.children;n&&n.forEach(function(e){this.buildSkeletons(e)},this)}},handleScene:{value:function(e,t,r){if(this._scenes||(this._scenes=[]),!t.nodes)return console.log("ERROR: invalid file required nodes property is missing from scene"),!1;var n=Object.create(f).init();n.ids=this._ids,n.id=e,n.name=t.name,n.baseURL=this.baseURL,this.storeEntry(e,n,t);var i=Object.create(h).init();return t.nodes&&t.nodes.forEach(function(e){var t=this.getEntry(e);i.children.push(t.entry),this.buildNodeHirerachy(t)},this),this.resolveParameterSources(),this.buildSkeletons(i),n.rootNode=i,this._scenes.push(n),!0}},handleSkin:{value:function(e,t,r){var n=Object.create(p).init();n.bindShapeMatrix=mat4.create(t.bindShapeMatrix),n.jointsIds=t.joints,n.inverseBindMatricesDescription=t.inverseBindMatrices,n.inverseBindMatricesDescription.id=e+"_inverseBindMatrices",n.inverseBindMatricesDescription.bufferView=this.getEntry(n.inverseBindMatricesDescription.bufferView).entry,this.storeEntry(e,n,t)}},handleNode:{value:function(e,t,r){var n=Object.create(h).init();n.id=e,n.jointId=t.jointId,n.name=t.name,this.storeEntry(e,n,t),n.transform=Object.create(v).initWithDescription(t);var i;if(t.mesh&&(i=this.getEntry(t.mesh),n.meshes.push(i.entry)),t.meshes&&t.meshes.forEach(function(e){i=this.getEntry(e),i&&n.meshes.push(i.entry)},this),t.camera){var s=this.getEntry(t.camera);s&&n.cameras.push(s.entry)}if(t.instanceSkin){t.instanceSkin.skin=this.getEntry(t.instanceSkin.skin).entry,n.instanceSkin=t.instanceSkin;var a=n.instanceSkin.sources;a&&a.forEach(function(e){i=this.getEntry(e),i&&n.meshes.push(i.entry)},this)}return!0}},handleLoadCompleted:{value:function(e){if(this.delegate){var t=null;if(this._state.options&&(t=this._state.options.ids),t)t.forEach(function(e){var t=this.getEntry(e);t&&this.delegate.loadCompleted(t.entry)},this);else if(this._scenes&&this.delegate&&this._scenes.length>0){var r=Object.create(g).init();r.animations=this._animations,this._scenes[0].animationManager=r,this.delegate.loadCompleted(this._scenes[0])}}}},handleAnimation:{value:function(e,t,r){this._animations||(this._animations=[]);var n=Object.create(y).initWithDescription(t);n.id=e,this.storeEntry(e,n,t);var i={};Object.keys(t.parameters).forEach(function(e){var r=t.parameters[e];switch(r.type){case"FLOAT_VEC4":componentsPerAttribute=4;break;case"FLOAT_VEC3":componentsPerAttribute=3;break;case"FLOAT_VEC2":componentsPerAttribute=2;break;case"FLOAT":componentsPerAttribute=1;break;default:console.log("type:"+r.type+" byteStride not handled")}r.byteStride=4*componentsPerAttribute,r.componentsPerAttribute=componentsPerAttribute,r.bufferView=this.getEntry(r.bufferView).entry,r.id=n.id+e,i[e]=r},this),n.parameters=i,n.channels.forEach(function(e){var t=e.target.id;e.path=e.target.path,e.target=this.getEntry(t).entry},this),Object.keys(n.samplers).forEach(function(e){var r=t.samplers[e],s=n.samplers[e],a=r.input,o=r.output;s.input=i[a],s.output=i[o]},this),this._animations.push(n)}},handleTexture:{value:function(e,t,r){if(t.source&&t.sampler)t.type="texture",t.source=this.getEntry(t.source).entry,t.sampler=this.getEntry(t.sampler).entry,t.id=e,this.storeEntry(e,t,t);else if(t.sources&&t.sampler){t.type="texture";for(var n=0;n<t.sources.length;n++)t.sources[n]=this.getEntry(t.sources[n]).entry;t.sampler=this.getEntry(t.sampler).entry,t.id=e,this.storeEntry(e,t,t)}else console.log("ERROR: texture"+e+" must contain both source and sampler properties")}},handleSampler:{value:function(e,t,r){t.id=t,this.storeEntry(e,t,t)}},handleError:{value:function(e){}},_delegate:{value:null,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(e){this._delegate=e}},_entries:{enumerable:!1,value:null,writable:!0},removeAllEntries:{value:function(){this._entries={}}},containsEntry:{enumerable:!1,value:function(e){return!!this._entries&&!!this._entries[e]}},storeEntry:{enumerable:!1,value:function(e,t,r){return null==this._entries&&(this._entries={}),null==this._ids&&(this._ids={}),t.baseId=e,this._ids[e]=t,(e+=this.loaderContext())?(t.id=e,this.containsEntry[e]&&console.log("WARNING: entry:"+e+" is already stored, overriding"),this._entries[e]={id:e,entry:t,description:r},e):void console.log("ERROR: not id provided, cannot store")}},getEntry:{enumerable:!1,value:function(e){return e+=this.loaderContext(),this._entries?this._entries[e]:null}}})}});