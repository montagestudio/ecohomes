montageDefine("c50fb48","runtime/skin",{dependencies:["runtime/dependencies/gl-matrix","runtime/base","runtime/transform","runtime/utilities"],factory:function(e,t,i){e("runtime/dependencies/gl-matrix");e("runtime/base").Base,e("runtime/transform").Transform,e("runtime/utilities").Utilities;t.Skin=Object.create(Object.prototype,{jointsIds:{value:null,writable:!0},nodesForSkeleton:{value:null,writable:!0},bindShapeMatrix:{value:null,writable:!0},inverseBindMatricesDescription:{value:null,writable:!0},matricesForSkeleton:{value:null,writable:!0},sources:{value:null,writable:!0},init:{value:function(){return this.jointsIds=[],this.nodesForSkeleton={},this.matricesForSkeleton={},this.sources=[],this}},inverseBindMatricesDelegate:{value:{handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t){return new Float32Array(e)},resourceAvailable:function(e,t){}}},process:{value:function(e,t){var i=Object.keys(this.nodesForSkeleton),r=mat4.create();mat4.inverse(e.worldTransform,r),i.forEach(function(e){var i=this.nodesForSkeleton[e],n=this.matricesForSkeleton[e];if(!n){var a=16*this.jointsIds.length;n=new Float32Array(a),this.matricesForSkeleton[e]=n;for(var s=mat4.identity(),o=0;o<a;o++)n[o]=s[o%16]}var l=t.getResource(this.inverseBindMatricesDescription,this.inverseBindMatricesDelegate);l&&this.sources.forEach(function(e){for(var t=e,a=this.bindShapeMatrix,s=this.jointsIds.length,o=mat4.create(),u=0;u<s;u++){for(var c=0;c<16;c++)o[c]=l[16*u+c];var m=i[u].worldTransform,v=mat4.identity();mat4.multiply(v,r),mat4.multiply(v,m),mat4.multiply(v,o),mat4.multiply(v,a);for(var c=0;c<16;c++)n[16*u+c]=v[c]}t.primitives.forEach(function(e){e.material.parameters&&(e.material.parameters.jointMat.value=n)},this)},this)},this)}}})}});