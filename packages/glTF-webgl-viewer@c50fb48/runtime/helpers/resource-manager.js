var global=window;!function(e,t){"object"==typeof exports?(module.exports=t(global),module.exports.ResourceManager=module.exports):"function"==typeof define&&define.amd?define([],function(){return t(e)}):t(e)}(this,function(e){"use strict";var t=Object.create(Object,{kind:{value:"multi-parts",writable:!0},range:{value:null,writable:!0},_requests:{value:null,writable:!0},requests:{get:function(){return this._requests},set:function(e){this._requests=e}},canMergeRequest:{value:function(e,t){var r=e.range[1]-e.range[0],s=this.range[1]-this.range[0];return!(r+s>t)&&((e.range[0]===this.range[1]||e.range[1]===this.range[0])&&e.type===this.type)}},mergeRequest:{value:function(e){0===this.requests.length?(this.requests.push(e),this.range=[e.range[0],e.range[1]]):e.range[0]===this.range[1]?(this.requests.push(e),this.range[1]=e.range[1]):e.range[1]===this.range[0]?(this.requests.unshift(e),this.range[0]=e.range[0]):console.log("ERROR: should not reach")}},mergeRequests:{value:function(e){if(this.range)if(e[0].range[1]<this.range[0])for(var t=e.length-1;t>=0;t--)this.mergeRequest(e[t]);else for(var t=0;t<e.length;t++)this.mergeRequest(e[t]);else e.forEach(function(e){this.mergeRequest(e)},this)}},id:{value:null,writable:!0},initWithRequests:{value:function(e){return this.requests=[],this.mergeRequests(e),this.id=e[0].id,this}}}),r=Object.create(Object,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(e){this._content=e}},_parent:{value:null,writable:!0},parent:{get:function(){return this._parent},set:function(e){this._parent=e}},_left:{value:null,writable:!0},left:{get:function(){return this._left},set:function(e){this._left=e}},_right:{value:null,writable:!0},right:{get:function(){return this._right},set:function(e){this._right=e}},_checkConsistency:{value:function(e){e.length>=50||(this.left&&this.left._checkConsistency(e),e.push(this.content.range),this.right&&this.right._checkConsistency(e))}},checkConsistency:{value:function(){var e=[];if(this._checkConsistency(e),e.length>1)for(var t=0;t<e.length-1;t++){var r=e[0],s=e[1];r[1]<=s[0]||console("ERROR: INCONSISTENCY CHECK Failed, ranges are not ordered in btree")}}},_collect:{value:function(e,t){this.left&&this.left._collect(e,t),e.length>=t||(e.push(this),this.right&&this.right._collect(e,t))}},collect:{value:function(e){var t=[];return this._collect(t,e),t}},insert:{value:function(e,t){if(e.range[1]<=this.content.range[0]){if(e.range[1]===this.content.range[0])return"multi-parts"===e.kind?this.content.mergeRequests(e.requests):this.content.mergeRequests(e),this.left&&this.content.canMergeRequest(this.left.content,t)&&(this.content.mergeRequests(this.left.content._requests),this.left.remove(this.left.content)),this.parent&&this.parent.content.canMergeRequest(this.content,t)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.left)return this.left.insert(e,t);var s=Object.create(r);return s.parent=this,s.content=e,this.left=s,s}if(e.range[0]>=this.content.range[1]){if(e.range[0]===this.content.range[1])return"multi-parts"===e.kind?this.content.mergeRequests(e.requests):this.content.mergeRequests(e),this.right&&this.content.canMergeRequest(this.right.content,t)&&(this.content.mergeRequests(this.right.content._requests),this.right.remove(this.right.content)),this.parent&&this.parent.content.canMergeRequest(this.content,t)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.right)return this.right.insert(e,t);var s=Object.create(r);return s.parent=this,s.content=e,this.right=s,s}console.log("ERROR: should not reach")}},contains:{value:function(e){return this.node===e||(!(!this.left||!this.left.contains(e))||!(!this.right||!this.right.contains(e)))}},min:{value:function(){for(var e=this;e.left;)e=e.left;return e}},_updateParentWithNode:{value:function(e){this.parent&&(this===this.parent.left?this.parent.left=e:this.parent.right=e),e&&(e.parent=this.parent)}},removeMin:{value:function(){this.parent;for(var e=this;e.left||e.right;)e.left&&(e=e.min()),e.right&&(e=e.right.min());return e._updateParentWithNode(null),e}},remove:{value:function(e){if(e.range[1]<=this.content.range[0])this.left.remove(e);else if(e.range[0]>=this.content.range[1])this.right.remove(e);else if(e===this.content)if(this.left&&this.right){var t=this.right.min();this.content=t.content,t._updateParentWithNode(t.right)}else this.left||this.right?this.left?this._updateParentWithNode(this.left):this._updateParentWithNode(this.right):this._updateParentWithNode(null)}}}),s=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"arraybuffer"},_resources:{value:null,writable:!0},_requestTrees:{value:null,writable:!0},requestTrees:{get:function(){return this._requestTrees}},_resourcesStatus:{value:null,writable:!0},_resourcesBeingProcessedCount:{value:0,writable:!0},_observers:{value:null,writable:!0},_maxConcurrentRequests:{value:1,writable:!0},observers:{get:function(){return this._observers},set:function(e){this._observers=e}},maxConcurrentRequests:{get:function(){return this._maxConcurrentRequests},set:function(e){this._maxConcurrentRequests=e}},reset:{value:function(){if(this._resourcesStatus){var e=Object.keys(this._resourcesStatus);e.forEach(function(e){var t=this._resourcesStatus[e];t&&t.xhr&&t.xhr.abort()},this)}var t=Object.keys(this._resources);t.forEach(function(e){var t=this._resources[e];t&&"VIDEO"===t.nodeName&&t.pause()},this),this._resources={},this._requestTrees={},this._resourcesStatus={},this._resourcesBeingProcessedCount=0,this._wholeBuffers={}}},_bytesLimit:{value:5e5,writable:!0},bytesLimit:{get:function(){return this._bytesLimit},set:function(e){this._bytesLimit!==e&&(this._bytesLimit=e)}},_containsResource:{enumerable:!1,value:function(e){return!!this._resources[e]}},init:{value:function(){this._requestTrees={},this._resources={},this._resourcesStatus={},this._observers=[],this._resourcesBeingProcessedCount=0}},_storeResource:{enumerable:!1,value:function(e,t){return e?(this._containsResource[e]&&console.log("WARNING: resource:"+e+" is already stored, overriding"),void(this._resources[e]=t)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(e){return this._resources[e]}},_loadResource:{value:function(e,t){var r,i=this,n=e.path;if("multi-parts"===e.kind?(r=e.requests[0].type,n=e.requests[0].path):(r=e.type,n=e.path),!r)return void t.handleError(s.INVALID_TYPE,null);if(!n)return void t.handleError(s.INVALID_PATH);var a=new XMLHttpRequest;if(a.open("GET",n,!0),a.responseType=r===this.ARRAY_BUFFER?"arraybuffer":"text",e.range){var u="bytes="+e.range[0]+"-"+(e.range[1]-1);a.setRequestHeader("Range",u)}a.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),a.onload=function(r){200==this.status||206==this.status?(i._resourcesBeingProcessedCount--,"multi-parts"===e.kind?e.requests.forEach(function(r){var s=this.response.slice(r.range[0]-e.range[0],r.range[1]-e.range[0]);t.resourceAvailable(i,r,s)},this):t.resourceAvailable(i,e,this.response)):t.handleError(s.XMLHTTPREQUEST_STATUS_ERROR,this.status)},a.send(null);var o=this._resourcesStatus[e.id];o&&(o.xhr=a)}},_processNextResource:{value:function(e){if(e){var t=!e.left&&!e.right;if(t)return this._handleRequest(e.content),!1;var r=e.removeMin();this._handleRequest(r.content)}return!0}},_observingEnabled:{value:!1,writable:!0},isObserving:{value:function(){return this._observingEnabled}},startObserving:{value:function(){this._observingEnabled=!0}},stopObserving:{value:function(){this._observingEnabled=!1}},fireResourceAvailable:{value:function(e){this._observingEnabled&&this.observers&&this.observers.forEach(function(t){t.resourceAvailable&&t.resourceAvailable(e)},this)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(e){var s=this._resourcesStatus[e.id],i=null,n=null,a=this.requestTrees?this.requestTrees[e.path]:null;if(s){if("loading"===s.status)return;i=s.node,n=s.status}if(this.wholeBuffer>=this.maxConcurrentRequests&&"arraybuffer"===e.type){if(!n){var u,o=null;if(u="multi-parts"===e.kind?Object.create(t).initWithRequests(e.requests):Object.create(t).initWithRequests([e]),a)o=a.insert(u,this.bytesLimit);else{var l=Object.create(r);l.content=u,this._requestTrees[e.path]=l,a=l,o=l}"multi-parts"===e.kind?e.requests.forEach(function(e){this._resourcesStatus[e.id]={status:"queued",node:o}},this):this._resourcesStatus[e.id]={status:"queued",node:o}}}else{var c=this,h={};"multi-parts"===e.kind?e.requests.forEach(function(e){this._resourcesStatus[e.id]={status:"loading"}},this):this._resourcesStatus[e.id]={status:"loading"},h.resourceAvailable=function(e,t,r){var s=t.delegate.convert(r,t.ctx);if(c._storeResource(t.id,s),t.delegate.resourceAvailable(s,t.ctx),delete c._resourcesStatus[t.id],c.fireResourceAvailable.call(c,t.id),c._resourcesBeingProcessedCount<c.maxConcurrentRequests){var i=e.requestTrees?e.requestTrees[t.path]:null;c._processNextResource(i)||i&&delete e.requestTrees[t.path]}},h.handleError=function(t,r){e.delegate.handleError(t,r)},c._resourcesBeingProcessedCount++,this._loadResource(e,h)}}},_elementSizeForGLType:{value:function(e){switch(e){case"FLOAT":return Float32Array.BYTES_PER_ELEMENT;case"UNSIGNED_BYTE":return Uint8Array.BYTES_PER_ELEMENT;case"UNSIGNED_SHORT":return Uint16Array.BYTES_PER_ELEMENT;case"FLOAT_VEC2":return 2*Float32Array.BYTES_PER_ELEMENT;case"FLOAT_VEC3":return 3*Float32Array.BYTES_PER_ELEMENT;case"FLOAT_VEC4":return 4*Float32Array.BYTES_PER_ELEMENT;case"FLOAT_MAT4":return 16*Float32Array.BYTES_PER_ELEMENT;case"FLOAT_MAT3":return 9*Float32Array.BYTES_PER_ELEMENT;default:return null}}},_allowRangedRequests:{value:!1,writable:!1},_wholeBuffers:{value:null,writable:!0},_handleWrappedBufferViewResourceLoading:{value:function(e,t,r){var s=e.bufferView;if(s)var i=s.buffer,n=e.byteOffset+s.description.byteOffset,a=[n,this._elementSizeForGLType(e.type)*e.count+n],u={id:e.id,range:a,type:e.requestType?e.requestType:i.description.type,path:i.description.path,delegate:t,ctx:r,kind:"single-part"};if(this._allowRangedRequests)this._handleRequest(u,null);else{this._wholeBuffers||(this._wholeBuffers={});var s=e.bufferView;if(s){var o=this,i=s.buffer,l=this._wholeBuffers[i.id];if(null==l){var c={};c.resourceAvailable=function(e,t,r){var s=o._wholeBuffers[t.id];e._storeResource(t.id,r),s.pendingRequests&&(s.pendingRequests.forEach(function(t){delete o._resourcesStatus[t.id];var s=r.slice(t.range[0],t.range[1]),i=t.delegate,n=i.convert(s,t.ctx);e._storeResource(t.id,n),i.resourceAvailable(n,t.ctx),o.fireResourceAvailable.call(o,t.id)},o),s.pendingRequests=[])},c.handleError=function(e,t){};var h={id:i.id,type:"arraybuffer",path:i.description.path,delegate:t,ctx:r,kind:"single-part"};o._resourcesBeingProcessedCount++,this._loadResource(h,c),l={activeRequest:"bufferRequest",pendingRequests:[]},this._wholeBuffers[i.id]=l}else{var d=this._getResource(i.id);if(d){var g=d.slice(u.range[0],u.range[1]),t=u.delegate,f=t.convert(g,u.ctx);return o._storeResource(u.id,f),t.resourceAvailable(f,u.ctx),void o.fireResourceAvailable.call(o,u.id)}}var _=this._resourcesStatus[u.id];if(_&&"loading"===_.status)return;l.pendingRequests.push(u),this._resourcesStatus[u.id]={status:"loading"}}}}},shaderDelegate:{value:{handleError:function(e,t){console.log("ERROR:shaderDelegate:"+e+" :"+t)},convert:function(e,t){return e},resourceAvailable:function(e,t){t.sources[t.stage]=e;if(t.sources["x-shader/x-fragment"]&&t.sources["x-shader/x-vertex"]){var r=t.programCtx.delegate,s=r.convert(t.sources,t.programCtx.ctx);t.programCtx.resourceManager._storeResource(t.programCtx.id,s),r.resourceAvailable(s,t.programCtx.ctx),t.programCtx.resourceManager.fireResourceAvailable.call(t.programCtx.resourceManager,t.programCtx.id)}}}},_handleProgramLoading:{value:function(e,t,r){var s={delegate:t,ctx:r,resourceManager:this,id:e.id},i={},n={stage:"x-shader/x-fragment",sources:i,programCtx:s},a={stage:"x-shader/x-vertex",sources:i,programCtx:s};this.getResource(e["x-shader/x-fragment"],this.shaderDelegate,n),this.getResource(e["x-shader/x-vertex"],this.shaderDelegate,a)}},_handleShaderLoading:{value:function(e,t,r){this._handleRequest({id:e.id,type:"text",path:e.description.path,delegate:t,ctx:r,kind:"single-part"},null)}},_handleVideoLoading:{value:function(e,t,r){var s=this._resourcesStatus[e.id];if(!s||"loading"!==s.status){this._resourcesStatus[e.id]={status:"loading"};var i=this;if(e.description.path){this._resourcesBeingProcessedCount++;var n=document.createElement("video");n.preload="auto",n.loop="loop",n.addEventListener("canplaythrough",function(){i._resourcesBeingProcessedCount--,n.play(),delete i._resourcesStatus[e.id],i._storeResource(e.id,n),t(n,e.id,r)}),n.src=e.description.path}}}},_handleImageLoading:{value:function(e,t,r,s){var i=this._resourcesStatus[e.id];if(!i||"loading"!==i.status){this._resourcesStatus[e.id]={status:"loading"};var n=this;if(e.description.path){this._resourcesBeingProcessedCount++;var a=new Image;a.onload=function(){n._resourcesBeingProcessedCount--,delete n._resourcesStatus[e.id],n._storeResource(e.id,a),t(a,e.id,r,s)},a.src=e.description.path}else e.description.image&&t(e.description.image,e.id,r,s)}}},_handleTextureLoading:{value:function(e,t,r){var s=this._resourcesStatus[e.id];if(!s||"loading"!==s.status){this._resourcesStatus[e.id]={status:"loading"};var i=this;if(e.source)"image"===e.source.type&&this._handleImageLoading(e.source,function(r,s,n){var a=n,u=t.convert(e,r);delete i._resourcesStatus[e.id],i._storeResource(e.id,u),t.resourceAvailable(u,a),i.fireResourceAvailable.call(i,e.id)},r),"video"===e.source.type&&this._handleVideoLoading(e.source,function(r,s,n){var a=n,u=t.convert(e,r);delete i._resourcesStatus[e.id],i._storeResource(e.id,u),t.resourceAvailable(u,a),i.fireResourceAvailable.call(i,e.id)},r);else if(e.sources){var n=0,a=[null,null,null,null,null,null],u=0;e.sources.forEach(function(s){"image"===s.type&&this._handleImageLoading(s,function(r,s,u,o){if(n++,a[o]=r,n==e.sources.length){var l=u,c=t.convert(e,a);delete i._resourcesStatus[e.id],i._storeResource(e.id,c),t.resourceAvailable(c,l),i.fireResourceAvailable.call(i,e.id)}},r,u++),"video"===s.type&&this._handleVideoLoading(s,function(r,s,o){if(n++,a[u]=r,n==e.sources.length){var l=o,c=t.convert(e,a);delete i._resourcesStatus[e.id],i._storeResource(e.id,c),t.resourceAvailable(c,l),i.fireResourceAvailable.call(i,e.id)}},r,u++)},this)}}}},setResource:{value:function(e,t){this._resources[e]=t}},getResource:{value:function(e,t,r){var s=this._getResource(e.id);return s?s:("program"===e.type?this._handleProgramLoading(e,t,r):"shader"===e.type?this._handleShaderLoading(e,t,r):"image"===e.type?this._handleImageLoading(e,t,r):"texture"===e.type?this._handleTextureLoading(e,t,r):this._handleWrappedBufferViewResourceLoading(e,t,r),null)}},hasPendingRequests:{value:function(){return this._resourcesBeingProcessedCount>0}},removeAllResources:{value:function(){this._resources={}}}});return e&&(e.ResourceManager=s),ResourceManager});