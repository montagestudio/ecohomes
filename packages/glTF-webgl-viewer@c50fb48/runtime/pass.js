require("runtime/dependencies/gl-matrix");var Montage=require("montage").Montage,glTFNode=require("runtime/glTF-node").glTFNode,NodeWrapper=require("runtime/node-wrapper").NodeWrapper,Projection=require("runtime/projection").Projection,Camera=require("runtime/camera").Camera,Utilities=require("runtime/utilities").Utilities,WebGLRenderer=require("runtime/webgl-renderer").WebGLRenderer,Transform=require("runtime/transform").Transform,ResourceDescription=require("runtime/resource-description").ResourceDescription,LinkedListNode=Object.create(Object.prototype,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(e){this._content=e}},_previous:{value:null,writable:!0},previous:{get:function(){return this._previous},set:function(e){this._previous=e}},_next:{value:null,writable:!0},next:{get:function(){return this._next},set:function(e){this._next=e}},init:{value:function(e){this.content=e,this.previous=null,this.next=null}},removeFromList:{value:function(){this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous),this.next=null,this.previous=null}}}),LinkedList=Object.create(Object.prototype,{_tail:{value:null,writable:!0},tail:{get:function(){return this._tail},set:function(e){this._tail=e}},_head:{value:null,writable:!0},head:{get:function(){return this._head},set:function(e){this._head=e}},append:{value:function(e){this.head||(this.head=e),this.tail&&(e.previous=this.tail,this.tail.next=e),this.tail=e}},remove:{value:function(e){var t=(e.content.id,!1),i=!1;this.tail===e&&(t=!0,this.tail=e.previous),this.head===e&&(i=!0,this.head=e.next)}}}),RenderTarget=exports.RenderTarget=Object.create(Object.prototype,{_extras:{value:null,writable:!0},_width:{value:0,writable:!0},_height:{value:0,writable:!0},_attachments:{value:null,writable:!0},attachments:{get:function(){return this._attachments},set:function(e){this._attachments=e}},init:{value:function(){return this.attachments=[],this.extras={},this}},width:{get:function(){return this._width},set:function(e){this._width=e}},height:{get:function(){return this._height},set:function(e){this._height=e}},extras:{get:function(){return this._extras},set:function(e){this._extras=e}}}),Pass=Object.create(Object.prototype,{_extras:{value:null,writable:!0},PROGRAM:{value:"program",writable:!1},SCENE:{value:"scene",writable:!1},_type:{value:null,writable:!0},type:{get:function(){return this._type}},extras:{get:function(){return this._extras},set:function(e){this._extras=e}}}),ProgramPass=exports.ProgramPass=Montage.specialize({_attributes:{value:null,writable:!0},_uniforms:{value:null,writable:!0},_states:{value:null,writable:!0},_program:{value:null,writable:!0},states:{get:function(){return this._states},set:function(e){this._states=e}},program:{get:function(){return this._program},set:function(e){this._program=e}},init:{value:function(){return this.attributes={},this.uniforms={},this.states={},this._type=Pass.PROGRAM,this.extras={},this}}}),ScenePassRenderer=Object.create(Object.prototype,{_nodeWrappers:{value:null,writable:!0},_pathIDsForNodeID:{value:null,writable:!0},_primitivesPerPass:{value:null,writable:!0},_viewPoint:{value:null,writable:!0},_scene:{value:null,writable:!0},_observers:{value:null,writable:!0},_viewPointMatrix:{value:null,writable:!0},addObserver:{value:function(e){null==this._observers&&(this._observers=[]),this._observers.indexOf(e)===-1?this._observers.push(e):console.log("WARNING attempt to add 2 times the same observer in sceneRenderer")}},removeObserver:{value:function(e){if(this._observers){var t=this._observers.indexOf(e);t!==-1&&this._observers.splice(t,1)}}},viewPoint:{get:function(){return this._viewPoint},set:function(e){if(this._observers)for(var t=0;t<this._observers.length;t++)this._observers[t].viewPointWillChange(this,this._viewPoint,e);if(this._viewPoint!=e&&(this._viewPoint=e),this._observers)for(var t=0;t<this._observers.length;t++)this._observers[t].viewPointMatrixDidUpdate(this),this._observers[t].viewPointDidChange(this)}},setupNodeAtPath:{value:function(e,t){var i=this._nodeWrappers[e.id];null==i&&(i=Object.create(NodeWrapper).init(e),this._nodeWrappers[e.id]=i,i.scenePassRenderer=this),e.meshes&&e.meshes.forEach(function(t){t.primitives&&t.primitives.forEach(function(s){if(s.material){var r=s.material.technique;if(r&&r.rootPass){var n,a=r.rootPass.id,o=null;for(n=0;n<this._primitivesPerPass.length;n++)this._primitivesPerPass[n].pass===a&&(o=this._primitivesPerPass[n]);null==o&&(o=this._primitivesPerPass[a]={pass:r.rootPass,primitives:[]},this._primitivesPerPass.push(o));var h={};t.compression&&(h.compressed=!0),h.primitive=s,h.node=e,h.nodeWrapper=i,o.primitives.push(h)}}},this)},this)}},sceneWillChange:{value:function(e,t){this._viewPointMatrix=mat4.identity()}},sceneDidChange:{value:function(){this._primitivesPerPass=[],this._nodeWrappers={};var e=this;this.scene&&this.scene.rootNode.apply(function(t,i,s){return e.setupNodeAtPath(t),null},!0,null)}},render:{value:function(e,t,i){if(this.scene&&this.viewPoint){null==this.__matrix&&(this.__matrix=mat4.create()),null==this.__transform&&(this.__transform=Object.create(Transform).init());var s=i.viewPointModifierMatrix;if(this.viewPoint){mat4.set(this.viewPoint.worldMatrix,this.__matrix);var r=i.interpolatingViewPoint;if(r){var n=(t-r.start)/1e3;if(null!=r.previous&&n<1){var a=r.previous.transform,o=this.viewPoint.transform;a.interpolateToTransform(o,n,this.__transform),mat4.multiply(this.viewPoint.parent.worldMatrix,this.__transform.matrix,this.__matrix)}}if(mat4.multiply(this.__matrix,s),mat4.inverse(this.__matrix),mat4.equal(this._viewPointMatrix,this.__matrix)===!1&&(mat4.set(this.__matrix,this._viewPointMatrix),this._observers))for(var h=0;h<this._observers.length;h++)this._observers[h].viewPointMatrixDidUpdate(this)}var u=!!i&&(1==i.picking&&i.coords);u&&(this.pickingRenderTarget.extras.coords=i.coords,e.bindRenderTarget(this.pickingRenderTarget));var c=this.scene.rootNode.nodeWithPropertyNamed("instanceSkin");c&&c.instanceSkin.skin.process(c,e.resourceManager),e.projectionMatrix=this.viewPoint.cameras[0].projection.matrix,null==this.__nonOpaquePassesWithPrimitives&&(this.__nonOpaquePassesWithPrimitives=[]),this.__nonOpaquePassesWithPrimitives.length=0;var l;for(l=0;l<this._primitivesPerPass.length;l++){var p=this._primitivesPerPass[l],v=u?this.pickingPass:p.pass,_=v.states;_.blendEnable&&!u?this.__nonOpaquePassesWithPrimitives.push(p):u&&this.pickingTechnique?e.renderPrimitivesWithPass(p.primitives,v,this.pickingTechnique.parameters,t):e.renderPrimitivesWithPass(p.primitives,v,null,t)}if(u){e.unbindRenderTarget(this.pickingRenderTarget);var d=this.pickingRenderTarget.extras.pickedPixel,g=null,m=Object.keys(this.pickingPass.extras.nodeIDToColor);m.forEach(function(e){var t=this.pickingPass.extras.nodeIDToColor[e];Math.abs(Math.round(255*t[0])-d[0])<=1&&Math.abs(Math.round(255*t[1])-d[1])<=1&&Math.abs(Math.round(255*t[2])-d[2])<=1&&(g=e)},this),i.delegate.handleSelectedNode(g)}else for(l=0;l<this.__nonOpaquePassesWithPrimitives.length;l++){var p=this.__nonOpaquePassesWithPrimitives[l];e.renderPrimitivesWithPass(p.primitives,p.pass,null,t)}}}},scene:{get:function(){return this._scene},set:function(e){this._scene!=e&&(this.sceneWillChange(this._scene,e),this._scene=e,this.sceneDidChange())}},_pickingPass:{value:null,writable:!0},pickingPass:{get:function(){return this._pickingPass},set:function(e){this._pickingPass=e,this._pickingPass.id="__PickingPass",this._pickingPass.extras.nodeIDToColor={}}},_pickingTechnique:{value:null,writable:!0},pickingTechnique:{get:function(){return this._pickingTechnique},set:function(e){this._pickingTechnique=e,this.pickingPass=this._pickingTechnique.rootPass}},_pickingRenderTarget:{value:null,writable:!0},pickingRenderTarget:{get:function(){return this._pickingRenderTarget},set:function(e){this._pickingRenderTarget=e}},createPickingRenderTargetIfNeeded:{value:function(){return this._pickingRenderTarget||(this._pickingRenderTarget=Object.create(RenderTarget).init(),this._pickingRenderTarget.attachments.push({semantic:"COLOR_ATTACHMENT0",parameter:"__pickingTexture"}),this._pickingRenderTarget.attachments.push({semantic:"DEPTH_ATTACHMENT",parameter:"__pickingRenderBuffer"}),this.pickingRenderTarget.extras.picking=!0),this._pickingRenderTarget}},init:{value:function(){return this.pickingRenderTarget=this.createPickingRenderTargetIfNeeded(),this.pickingRenderTarget.width=512,this.pickingRenderTarget.height=512,this._nodeWrappers={},this}}}),ScenePass=exports.ScenePass=Object.create(Pass,{_sceneRenderer:{value:null,writable:!0},createSceneRendererIfNeeded:{value:function(){this._sceneRenderer||(this._sceneRenderer=Object.create(ScenePassRenderer).init())}},sceneRenderer:{get:function(){return this.createSceneRendererIfNeeded(),this._sceneRenderer},set:function(e){this.createSceneRendererIfNeeded(),this._sceneRenderer!=e&&(this._sceneRenderer=e)}},viewPoint:{get:function(){return this.sceneRenderer?this.sceneRenderer.viewPoint:null},set:function(e){this.sceneRenderer&&(this.sceneRenderer.viewPoint=e)}},scene:{get:function(){return this.sceneRenderer.scene},set:function(e){this.sceneRenderer.scene=e}},execute:{value:function(e,t,i){this.sceneRenderer.render(e,t,i)}},init:{value:function(){return this._type=Pass.SCENE,this.extras={},this}}});