montageDefine("c50fb48","runtime/pass",{dependencies:["runtime/dependencies/gl-matrix","montage","runtime/glTF-node","runtime/node-wrapper","runtime/projection","runtime/camera","runtime/utilities","runtime/webgl-renderer","runtime/transform","runtime/resource-description"],factory:function(e,t,i){e("runtime/dependencies/gl-matrix");var n=e("montage").Montage,s=(e("runtime/glTF-node").glTFNode,e("runtime/node-wrapper").NodeWrapper),r=(e("runtime/projection").Projection,e("runtime/camera").Camera,e("runtime/utilities").Utilities,e("runtime/webgl-renderer").WebGLRenderer,e("runtime/transform").Transform),a=(e("runtime/resource-description").ResourceDescription,Object.create(Object.prototype,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(e){this._content=e}},_previous:{value:null,writable:!0},previous:{get:function(){return this._previous},set:function(e){this._previous=e}},_next:{value:null,writable:!0},next:{get:function(){return this._next},set:function(e){this._next=e}},init:{value:function(e){this.content=e,this.previous=null,this.next=null}},removeFromList:{value:function(){this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous),this.next=null,this.previous=null}}}),Object.create(Object.prototype,{_tail:{value:null,writable:!0},tail:{get:function(){return this._tail},set:function(e){this._tail=e}},_head:{value:null,writable:!0},head:{get:function(){return this._head},set:function(e){this._head=e}},append:{value:function(e){this.head||(this.head=e),this.tail&&(e.previous=this.tail,this.tail.next=e),this.tail=e}},remove:{value:function(e){var t=(e.content.id,!1),i=!1;this.tail===e&&(t=!0,this.tail=e.previous),this.head===e&&(i=!0,this.head=e.next)}}}),t.RenderTarget=Object.create(Object.prototype,{_extras:{value:null,writable:!0},_width:{value:0,writable:!0},_height:{value:0,writable:!0},_attachments:{value:null,writable:!0},attachments:{get:function(){return this._attachments},set:function(e){this._attachments=e}},init:{value:function(){return this.attachments=[],this.extras={},this}},width:{get:function(){return this._width},set:function(e){this._width=e}},height:{get:function(){return this._height},set:function(e){this._height=e}},extras:{get:function(){return this._extras},set:function(e){this._extras=e}}})),o=Object.create(Object.prototype,{_extras:{value:null,writable:!0},PROGRAM:{value:"program",writable:!1},SCENE:{value:"scene",writable:!1},_type:{value:null,writable:!0},type:{get:function(){return this._type}},extras:{get:function(){return this._extras},set:function(e){this._extras=e}}}),h=(t.ProgramPass=n.specialize({_attributes:{value:null,writable:!0},_uniforms:{value:null,writable:!0},_states:{value:null,writable:!0},_program:{value:null,writable:!0},states:{get:function(){return this._states},set:function(e){this._states=e}},program:{get:function(){return this._program},set:function(e){this._program=e}},init:{value:function(){return this.attributes={},this.uniforms={},this.states={},this._type=o.PROGRAM,this.extras={},this}}}),Object.create(Object.prototype,{_nodeWrappers:{value:null,writable:!0},_pathIDsForNodeID:{value:null,writable:!0},_primitivesPerPass:{value:null,writable:!0},_viewPoint:{value:null,writable:!0},_scene:{value:null,writable:!0},_observers:{value:null,writable:!0},_viewPointMatrix:{value:null,writable:!0},addObserver:{value:function(e){null==this._observers&&(this._observers=[]),this._observers.indexOf(e)===-1?this._observers.push(e):console.log("WARNING attempt to add 2 times the same observer in sceneRenderer")}},removeObserver:{value:function(e){if(this._observers){var t=this._observers.indexOf(e);t!==-1&&this._observers.splice(t,1)}}},viewPoint:{get:function(){return this._viewPoint},set:function(e){if(this._observers)for(var t=0;t<this._observers.length;t++)this._observers[t].viewPointWillChange(this,this._viewPoint,e);if(this._viewPoint!=e&&(this._viewPoint=e),this._observers)for(var t=0;t<this._observers.length;t++)this._observers[t].viewPointMatrixDidUpdate(this),this._observers[t].viewPointDidChange(this)}},setupNodeAtPath:{value:function(e,t){var i=this._nodeWrappers[e.id];null==i&&(i=Object.create(s).init(e),this._nodeWrappers[e.id]=i,i.scenePassRenderer=this),e.meshes&&e.meshes.forEach(function(t){t.primitives&&t.primitives.forEach(function(n){if(n.material){var s=n.material.technique;if(s&&s.rootPass){var r,a=s.rootPass.id,o=null;for(r=0;r<this._primitivesPerPass.length;r++)this._primitivesPerPass[r].pass===a&&(o=this._primitivesPerPass[r]);null==o&&(o=this._primitivesPerPass[a]={pass:s.rootPass,primitives:[]},this._primitivesPerPass.push(o));var h={};t.compression&&(h.compressed=!0),h.primitive=n,h.node=e,h.nodeWrapper=i,o.primitives.push(h)}}},this)},this)}},sceneWillChange:{value:function(e,t){this._viewPointMatrix=mat4.identity()}},sceneDidChange:{value:function(){this._primitivesPerPass=[],this._nodeWrappers={};var e=this;this.scene&&this.scene.rootNode.apply(function(t,i,n){return e.setupNodeAtPath(t),null},!0,null)}},render:{value:function(e,t,i){if(this.scene&&this.viewPoint){null==this.__matrix&&(this.__matrix=mat4.create()),null==this.__transform&&(this.__transform=Object.create(r).init());var n=i.viewPointModifierMatrix;if(this.viewPoint){mat4.set(this.viewPoint.worldMatrix,this.__matrix);var s=i.interpolatingViewPoint;if(s){var a=(t-s.start)/1e3;if(null!=s.previous&&a<1){var o=s.previous.transform,h=this.viewPoint.transform;o.interpolateToTransform(h,a,this.__transform),mat4.multiply(this.viewPoint.parent.worldMatrix,this.__transform.matrix,this.__matrix)}}if(mat4.multiply(this.__matrix,n),mat4.inverse(this.__matrix),mat4.equal(this._viewPointMatrix,this.__matrix)===!1&&(mat4.set(this.__matrix,this._viewPointMatrix),this._observers))for(var u=0;u<this._observers.length;u++)this._observers[u].viewPointMatrixDidUpdate(this)}var c=!!i&&(1==i.picking&&i.coords);c&&(this.pickingRenderTarget.extras.coords=i.coords,e.bindRenderTarget(this.pickingRenderTarget));var l=this.scene.rootNode.nodeWithPropertyNamed("instanceSkin");l&&l.instanceSkin.skin.process(l,e.resourceManager),e.projectionMatrix=this.viewPoint.cameras[0].projection.matrix,null==this.__nonOpaquePassesWithPrimitives&&(this.__nonOpaquePassesWithPrimitives=[]),this.__nonOpaquePassesWithPrimitives.length=0;var p;for(p=0;p<this._primitivesPerPass.length;p++){var v=this._primitivesPerPass[p],_=c?this.pickingPass:v.pass,d=_.states;d.blendEnable&&!c?this.__nonOpaquePassesWithPrimitives.push(v):c&&this.pickingTechnique?e.renderPrimitivesWithPass(v.primitives,_,this.pickingTechnique.parameters,t):e.renderPrimitivesWithPass(v.primitives,_,null,t)}if(c){e.unbindRenderTarget(this.pickingRenderTarget);var g=this.pickingRenderTarget.extras.pickedPixel,m=null,f=Object.keys(this.pickingPass.extras.nodeIDToColor);f.forEach(function(e){var t=this.pickingPass.extras.nodeIDToColor[e];Math.abs(Math.round(255*t[0])-g[0])<=1&&Math.abs(Math.round(255*t[1])-g[1])<=1&&Math.abs(Math.round(255*t[2])-g[2])<=1&&(m=e)},this),i.delegate.handleSelectedNode(m)}else for(p=0;p<this.__nonOpaquePassesWithPrimitives.length;p++){var v=this.__nonOpaquePassesWithPrimitives[p];e.renderPrimitivesWithPass(v.primitives,v.pass,null,t)}}}},scene:{get:function(){return this._scene},set:function(e){this._scene!=e&&(this.sceneWillChange(this._scene,e),this._scene=e,this.sceneDidChange())}},_pickingPass:{value:null,writable:!0},pickingPass:{get:function(){return this._pickingPass},set:function(e){this._pickingPass=e,this._pickingPass.id="__PickingPass",this._pickingPass.extras.nodeIDToColor={}}},_pickingTechnique:{value:null,writable:!0},pickingTechnique:{get:function(){return this._pickingTechnique},set:function(e){this._pickingTechnique=e,this.pickingPass=this._pickingTechnique.rootPass}},_pickingRenderTarget:{value:null,writable:!0},pickingRenderTarget:{get:function(){return this._pickingRenderTarget},set:function(e){this._pickingRenderTarget=e}},createPickingRenderTargetIfNeeded:{value:function(){return this._pickingRenderTarget||(this._pickingRenderTarget=Object.create(a).init(),this._pickingRenderTarget.attachments.push({semantic:"COLOR_ATTACHMENT0",parameter:"__pickingTexture"}),this._pickingRenderTarget.attachments.push({semantic:"DEPTH_ATTACHMENT",parameter:"__pickingRenderBuffer"}),this.pickingRenderTarget.extras.picking=!0),this._pickingRenderTarget}},init:{value:function(){return this.pickingRenderTarget=this.createPickingRenderTargetIfNeeded(),this.pickingRenderTarget.width=512,this.pickingRenderTarget.height=512,this._nodeWrappers={},this}}}));t.ScenePass=Object.create(o,{_sceneRenderer:{value:null,writable:!0},createSceneRendererIfNeeded:{value:function(){this._sceneRenderer||(this._sceneRenderer=Object.create(h).init())}},sceneRenderer:{get:function(){return this.createSceneRendererIfNeeded(),this._sceneRenderer},set:function(e){this.createSceneRendererIfNeeded(),this._sceneRenderer!=e&&(this._sceneRenderer=e)}},viewPoint:{get:function(){return this.sceneRenderer?this.sceneRenderer.viewPoint:null},set:function(e){this.sceneRenderer&&(this.sceneRenderer.viewPoint=e)}},scene:{get:function(){return this.sceneRenderer.scene},set:function(e){this.sceneRenderer.scene=e}},execute:{value:function(e,t,i){this.sceneRenderer.render(e,t,i)}},init:{value:function(){return this._type=o.SCENE,this.extras={},this}}})}});