require("runtime/dependencies/gl-matrix");var Montage=require("montage").Montage,Component=require("montage/ui/component").Component,GLSLProgram=require("runtime/glsl-program").GLSLProgram,ResourceManager=require("runtime/helpers/resource-manager").ResourceManager,glTFScene=require("runtime/glTF-scene").glTFScene,glTFNode=require("runtime/glTF-node").glTFNode,Scene=require("runtime/scene").Scene,Node=require("runtime/node").Node,SceneRenderer=require("runtime/scene-renderer").SceneRenderer,glTFMaterial=require("runtime/glTF-material").glTFMaterial,Utilities=require("runtime/utilities").Utilities,dom=require("montage/core/dom"),Point=require("montage/core/geometry/point").Point,OrbitCamera=require("runtime/dependencies/camera").OrbitCamera,FlyingCamera=require("runtime/dependencies/camera").FlyingCamera,TranslateComposer=require("montage/composer/translate-composer").TranslateComposer,BuiltInAssets=require("runtime/builtin-assets").BuiltInAssets,WebGLRenderer=require("runtime/webgl-renderer").WebGLRenderer,URL=require("url"),Projection=require("runtime/projection").Projection,Camera=require("runtime/camera").Camera;exports.View=Component.specialize({_firstFrameDidRender:{value:!1,writable:!0},_sceneResourcesLoaded:{value:!1,writable:!0},_scene:{value:null,writable:!0},allowsProgressiveSceneLoading:{value:!1,writable:!0},sceneWillChange:{value:function(e){this.viewPointModifierMatrix=mat4.identity(),this.interpolatingViewPoint=null,this._firstFrameDidRender=!1,this.delegate&&this.delegate.sceneWillChange&&this.delegate.sceneWillChange(),this._scene&&(this._scene.removeEventListener("materialUpdate",this),this._scene.removeEventListener("textureUpdate",this))}},sceneDidChange:{value:function(){this._scene&&(this._sceneResourcesLoaded=!1,this._scene.addEventListener("textureUpdate",this),this._scene.addEventListener("materialUpdate",this),this.applyScene(),this.delegate&&this.delegate.sceneDidChange&&this.delegate.sceneDidChange())}},scene:{get:function(){return this._scene},set:function(e){return e&&e.isLoaded()===!1?void e.addOwnPropertyChangeListener("status",this):void(this.scene!=e&&(this.sceneWillChange(e),this._scene=e,this.sceneDidChange()))}},constructor:{value:function(){this["super"]()}},resourceAvailable:{value:function(e){if(0==this.allowsProgressiveSceneLoading){var t=this.getResourceManager();t&&0==t.hasPendingRequests()&&(this.needsDraw=!0)}}},handleTextureUpdate:{value:function(e){var t=this.getResourceManager();if(t&&this.sceneRenderer&&this.sceneRenderer.webGLRenderer){var i=this.sceneRenderer.webGLRenderer.webGLContext,n=t.getResource(e.detail.value,this.sceneRenderer.webGLRenderer.textureDelegate,i);n&&(this.needsDraw=!0)}}},handleMaterialUpdate:{value:function(e){this.needsDraw=!0}},_sceneTime:{value:0,writable:!0},_lastTime:{value:0,writable:!0},play:{value:function(){switch(this._state){case this.PAUSE:case this.STOP:this._lastTime=Date.now(),this._state=this.PLAY,this.needsDraw=!0}this._state=this.PLAY}},pause:{value:function(){this._state=this.PAUSE}},_viewPointIndex:{value:0,writable:!0},automaticallyCycleThroughViewPoints:{value:!0,writable:!0},loops:{value:!0,writable:!0},stop:{value:function(){this._sceneTime=0,this._state=this.STOP,this.needsDraw=!0}},STOP:{value:0,writable:!0},PLAY:{value:1,writable:!0},PAUSE:{value:2,writable:!0},_state:{value:0,writable:!0},_viewPoint:{value:null,writable:!0},viewPointWillChange:{value:function(e,t){var i=null;if(this.sceneRenderer&&t){if(this.scene&&this.scene.glTFElement){var n=this.scene.glTFElement.animationManager,r=0==n.nodeHasAnimatedAncestor(t.glTFElement);if(0==r&&null!=e&&(r|=0==n.nodeHasAnimatedAncestor(e.glTFElement)),r){var s=null==this.orbitCamera?null:[this.orbitCamera.orbitX,this.orbitCamera.orbitY];i={previous:e?e.glTFElement:null,step:0,start:Date.now(),duration:1e3,orbitXY:s,orbitDistance:this.orbitCamera?this.orbitCamera.getDistance():0}}}this.interpolatingViewPoint=i}}},viewPointDidChange:{value:function(){this.sceneRenderer&&this._viewPoint&&this.scene&&this.scene.glTFElement&&(this.sceneRenderer.technique.rootPass.viewPoint=this._viewPoint?this._viewPoint.glTFElement:null,this._viewPointIndex=this._getViewPointIndex(this.viewPoint),this.needsDraw=!0)}},viewPoint:{get:function(){return this._viewPoint},set:function(e){if(this._viewPoint!=e){var t=null;this._viewPoint&&e&&this._viewPoint.scene==e.scene&&(t=this._viewPoint),this.viewPointWillChange(t,e),this._viewPoint=e,this._sceneTime=0,e&&this.scene&&null==this._viewPoint.scene&&(this._viewPoint.scene=this.scene),this.viewPointDidChange()}}},translateComposer:{value:null},modelController:{value:null},update:{value:function(){this.needsDraw=!0}},scaleFactor:{value:window.devicePixelRatio||1,writable:!0},canvas:{get:function(){return this.templateObjects?this.templateObjects.canvas:null}},_orbitCamera:{value:null,writable:!0},orbitCamera:{get:function(){return this._orbitCamera},set:function(e){this._orbitCamera=e}},_sceneRenderer:{value:null,writable:!0},sceneRenderer:{get:function(){return this._sceneRenderer},set:function(e){e!=this._sceneRenderer&&(this._sceneRenderer=e)}},handleStatusChange:{value:function(e,t,i){"loaded"===e&&(this.scene=i,this.needsDraw=!0,this.interpolatingViewPoint=null)}},scenePath:{set:function(e){if(e){var t=URL.parse(e);if(!t.scheme){var i=Object.keys(require.packages);e=URL.resolve(i[0],e)}}if(!this.scene||e!=this.scene.path){var n=Montage.create(Scene).init();n.addOwnPropertyChangeListener("status",this),n.path=e}},get:function(){return this.scene?this.scene.path:null}},_getGLTFViewPoints:{value:function(e){var t=[],i=e.glTFElement.rootNode;return i.apply(function(e,i,n){return e.cameras&&e.cameras.length&&(t=t.concat(e)),null},!0,null),t}},_getViewPoints:{value:function(e){var t=this._getGLTFViewPoints(e),i=[];return t.forEach(function(t){var n=new Node;n.scene=e,n.id=t.baseId,i.push(n)},this),i}},_getViewPointIndex:{value:function(e){for(var t=this._getGLTFViewPoints(e.scene),i=0;i<t.length;i++)if(t[i].baseId===e.id)return i;return 0}},applyScene:{value:function(){var e=this.scene,t=null,i=e.glTFElement,n=this;if(this.sceneRenderer&&this.sceneRenderer.technique.rootPass){if(i){this.orbitCamera=null;var r=this._getViewPoints(e),s=r.length>0,a=mat4.identity(),o=i.rootNode,h=null;if(o.apply(function(e,t,i){var n=mat4.create();if(mat4.multiply(i,e.transform.matrix,n),e.boundingBox){var r=Utilities.transformBBox(e.boundingBox,n);h?e.meshes&&e.meshes.length>0&&(h=Utilities.mergeBBox(r,h)):h=r}return n},!0,a),r.length){var l=!1;this.viewPoint&&this.viewPoint.scene&&(l=this.viewPoint.scenePath===e.scenePath),l===!1&&(this.viewPoint=r[0])}else{var c=Object.create(Projection);c.initWithDescription({projection:"perspective",yfov:45,aspectRatio:1,znear:.1,zfar:100});var u=Object.create(Camera).init();u.projection=c;var d=Object.create(glTFNode).init();u.name=d.name="camera01",d.id="__default_camera",d.baseId=d.id,i.ids[d.baseId]=d,d.cameras.push(u);var m=Montage.create(Node);m.scene=e,m.id=d.baseId,this.viewPoint=m}if(h&&!s){var v=[h[1][0]-h[0][0],h[1][1]-h[0][1],h[1][2]-h[0][2]],g=v[0]>v[1]?v[0]:v[1];g=v[2]>g?v[2]:g,g=1/g;var w=mat4.scale(mat4.identity(),[g,g,g]);t=vec3.createFrom(0,0,v[2]*g/2);var _=vec3.createFrom(-(v[0]/2+h[0][0]),-(v[1]/2+h[0][1]),-h[0][2]),f=mat4.translate(w,[_[0],_[1],_[2]]);mat4.set(f,i.rootNode.transform.matrix),i.rootNode.transform._updateDirtyFlag(!1)}}if(this.sceneRenderer.scene=i,i?(this.orbitCamera=new MontageOrbitCamera(this.canvas),this.orbitCamera.translateComposer=this.translateComposer,this.orbitCamera._hookEvents(this.canvas),this.orbitCamera.constrainDistance=!!s,this.orbitCamera.maxDistance=s?15:200,this.orbitCamera.minDistance=s?-45:0,this.orbitCamera.setDistance(s?0:1.3),this.orbitCamera.distanceStep=s?.015:1e-4,this.orbitCamera.setRideMode(s),this.orbitCamera.setYUp(!0),s&&(this.orbitCamera.minOrbitX=-.4,this.orbitCamera.maxOrbitX=.4,this.orbitCamera.minOrbitY=-.4,this.orbitCamera.maxOrbitY=.4),this.orbitCamera.constrainXOrbit=s,this.orbitCamera.constrainYOrbit=s,t&&this.orbitCamera.setCenter(t)):this.flyingCamera=new MontageFlyingCamera(this.canvas),this.viewPoint&&(null==this.viewPoint.scene&&(this.viewPoint.scene=e),this.sceneRenderer&&(this.interpolatingViewPoint=null,this.viewPointDidChange())),this.allowsProgressiveSceneLoading===!1){var b=this.scene.prepareToRender(this.sceneRenderer.webGLRenderer);b.then(function(){n.sceneRenderer.webGLRenderer.webGLContext.finish(),n._sceneResourcesLoaded=!0,n.needsDraw=!0},function(e){},function(e){})}else this.needsDraw=!0}}},getRelativePositionToCanvas:{value:function(e){return dom.convertPointFromPageToNode(this.canvas,(new Point).init(e.pageX,e.pageY))}},_disableRendering:{value:!1,writable:!0},_contextAttributes:{value:null,writable:!0},_shouldForceClear:{value:!1,writable:!0},enterDocument:{value:function(e){var t=!1,i=this;t&&(this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(this.canvas));var n={premultipliedAlpha:!1,antialias:!0,preserveDrawingBuffer:!1},r=this.canvas.getContext("experimental-webgl",n)||this.canvas.getContext("webgl",n);if(null==r)return void console.log("Please check that your browser enables & supports WebGL");this._contextAttributes=r.getContextAttributes();var s=!1;if(this._contextAttributes&&(s=this._contextAttributes.antialias),0==s&&console.log("WARNING: anti-aliasing is not supported/enabled"),navigator){var a=null!=navigator.userAgent.match(/iPad/i);if(0==a){var o=navigator.userAgent;a=/iPad/i.test(o)||/iPhone OS 3_1_2/i.test(o)||/iPhone OS 3_2_2/i.test(o)}a&&(this._shouldForceClear=!0)}var h=Object.create(WebGLRenderer).initWithWebGLContext(r);r.enable(r.DEPTH_TEST);var l=null;this.sceneRenderer=Object.create(SceneRenderer),this.sceneRenderer.init(h,l);var c=this.getResourceManager();c.isObserving()||(c.observers.push(this),c.startObserving()),this.scene&&this.applyScene(),this.canvas.addEventListener("webglcontextlost",function(e){console.log("context was lost"),e.preventDefault(),i.getResourceManager.stopObserving(),i.sceneRenderer.webGLRenderer.resourceManager.reset(),i.needsDraw=!1,i._disableRendering=!0},!1),this.canvas.addEventListener("webglcontextrestored",function(e){console.log("context was restored"),e.preventDefault(),r.enable(r.DEPTH_TEST),i.needsDraw=!0,i._disableRendering=!1},!1),t&&setTimeout(function(){i.canvas.loseContext()},5e3);var i=this,u=BuiltInAssets.assetWithName("gradient");u.then(function(e){i.gradientRenderer=Object.create(SceneRenderer),i.gradientRenderer.init(h,null),i.gradientRenderer.scene=e,i.needsDraw=!0},function(e){},function(e){}),this.needsDraw=!0,this.canvas.addEventListener("touchstart",this.start.bind(this),!0),document.addEventListener("touchend",this.end.bind(this),!0),document.addEventListener("touchcancel",this.end.bind(this),!0),document.addEventListener("touchmove",this.move.bind(this),!0),document.addEventListener("gesturechange",this,!0),this.canvas.addEventListener("mousedown",this.start.bind(this),!0),document.addEventListener("mouseup",this.end.bind(this),!0),document.addEventListener("mousemove",this.move.bind(this),!0),document.addEventListener("mousewheel",this,!0)}},captureMousewheel:{value:function(){this.needsDraw=!0}},captureGesturechange:{value:function(){this.needsDraw=!0}},move:{value:function(e){this._mousePosition=null}},start:{value:function(e){e.preventDefault(),this._consideringPointerForPicking=!0;var t=this.getRelativePositionToCanvas(e);this._mousePosition=[t.x*this.scaleFactor,this.height-t.y*this.scaleFactor],this._state==this.PLAY&&this.pause()}},end:{value:function(e){if(this._consideringPointerForPicking&&e.target===this.canvas&&e.preventDefault(),this._state==this.PAUSE&&this.scene&&this.viewPoint&&this.scene.glTFElement&&this.scene.glTFElement.animationManager){var t=this.scene.glTFElement.animationManager;t.nodeHasAnimatedAncestor(this.viewPoint.glTFElement)&&this.play()}this._consideringPointerForPicking=!1,this._mousePosition=null}},hitTest:{value:function(e,t){if(this.sceneRenderer&&this.sceneRenderer.technique.rootPass&&this.canvas){var i=[0,0,parseInt(this.canvas.getAttribute("width")),parseInt(this.canvas.getAttribute("height"))];return this.sceneRenderer.technique.rootPass.hitTest(e,i,t)}return null}},getWebGLRenderer:{value:function(){return this.sceneRenderer?this.sceneRenderer.webGLRenderer:null}},getWebGLContext:{value:function(){var e=this.getWebGLRenderer();return e?e.webGLContext:null}},getResourceManager:{value:function(){var e=this.getWebGLRenderer();return e?e.resourceManager:null}},_consideringPointerForPicking:{writable:!0,value:!1},_mousePosition:{writable:!0,value:null},_floorTextureLoaded:{writable:!0,value:!1},_showGradient:{value:!1,writable:!0},_showReflection:{value:!1,writable:!0},showBBOX:{value:!1,writable:!0},showGradient:{get:function(){return this._showGradient},set:function(e){e!=this._showGradient&&(this._showGradient=e,this.needsDraw=!0)}},showReflection:{get:function(){return this._showReflection},set:function(e){this._showReflection=e}},drawGradient:{value:function(){this.showGradient&&this.gradientRenderer&&this.gradientRenderer.render()}},displayBBOX:{value:function(e,t,i){if(this.sceneRenderer&&this.scene&&this.sceneRenderer.technique.rootPass.viewPoint){var n=this.getWebGLContext();this.sceneRenderer.webGLRenderer.bindedProgram=null;var r=this.viewPoint,s=r.cameras[0].projection.matrix;if(n.disable(n.CULL_FACE),!this._BBOXProgram){this._BBOXProgram=Object.create(GLSLProgram);var a="precision highp float;attribute vec3 vert;uniform mat4 u_projMatrix; uniform mat4 u_vMatrix; uniform mat4 u_mMatrix; void main(void) { gl_Position = u_projMatrix * u_vMatrix * u_mMatrix * vec4(vert,1.0); }",o="precision highp float;uniform float u_transparency;  void main(void) {  gl_FragColor = vec4(vec3(1.,1.,1.) , u_transparency);}";this._BBOXProgram.initWithShaders({"x-shader/x-vertex":a,"x-shader/x-fragment":o}),this._BBOXProgram.build(n)||console.log(this._BBOXProgram.errorLogs)}var h=[e[0][0],e[0][1],e[0][2]],l=[e[1][0],e[1][1],e[1][2]],c=0,u=1,d=2;if(!this._BBOXIndices){var m=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,3,7,2,6,0,4,1,5];this._BBOXIndices=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._BBOXIndices),n.bufferData(n.ELEMENT_ARRAY_BUFFER,new Uint16Array(m),n.STATIC_DRAW)}n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._BBOXIndices),this._BBOXVertexBuffer||(this._BBOXVertexBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this._BBOXVertexBuffer)),n.bindBuffer(n.ARRAY_BUFFER,this._BBOXVertexBuffer);var v=[l[c],h[u],h[d],l[c],l[u],h[d],h[c],l[u],h[d],h[c],h[u],h[d],l[c],h[u],l[d],l[c],l[u],l[d],h[c],l[u],l[d],h[c],h[u],l[d]];n.bufferData(n.ARRAY_BUFFER,new Float32Array(v),n.STATIC_DRAW);var g=this._BBOXProgram.getLocationForSymbol("vert");"undefined"!=typeof g&&(n.enableVertexAttribArray(g),n.vertexAttribPointer(g,3,n.FLOAT,!1,12,0)),this.sceneRenderer.webGLRenderer.bindedProgram=this._BBOXProgram;var w=this._BBOXProgram.getLocationForSymbol("u_projMatrix");w&&this._BBOXProgram.setValueForSymbol("u_projMatrix",s);var _=this._BBOXProgram.getLocationForSymbol("u_mMatrix");_&&this._BBOXProgram.setValueForSymbol("u_mMatrix",i);var f=this._BBOXProgram.getLocationForSymbol("u_vMatrix");f&&this._BBOXProgram.setValueForSymbol("u_vMatrix",t);var b=this._BBOXProgram.getLocationForSymbol("u_transparency");b&&this._BBOXProgram.setValueForSymbol("u_transparency",1),this._BBOXProgram.commit(n),n.drawElements(n.LINES,24,n.UNSIGNED_SHORT,0),n.disableVertexAttribArray(g),n.disable(n.BLEND),n.enable(n.CULL_FACE)}}},selectedNode:{value:null,writable:!0},handleSelectedNode:{value:function(e){}},displayAllBBOX:{value:function(e,t){if(this.scene&&this.showBBOX&&this.scene.glTFElement){var i=mat4.identity(),n=this.scene.glTFElement.rootNode,r=this;n.apply(function(i,n,s){var a=mat4.create();return mat4.multiply(s,i.transform.matrix,a),i.boundingBox&&i.id==t&&r.displayBBOX(i.boundingBox,e,a),a},!0,i)}}},_width:{value:null},width:{get:function(){return this._width},set:function(e){e!=this._width&&(this._width=e*this.scaleFactor,this.needsDraw=!0)}},_height:{value:null},height:{get:function(){return this._height},set:function(e){e!=this._height&&(this._height=e*this.scaleFactor,this.needsDraw=!0)}},interpolatingViewPoint:{value:null,writable:!0},draw:{value:function(){if(this.allowsProgressiveSceneLoading!==!1||this._sceneResourcesLoaded!==!1){var e,t,i=this.getWebGLContext();if(null!=i&&!this._disableRendering&&((this._shouldForceClear||null==this._contextAttributes.preserveDrawingBuffer||1==this._contextAttributes.preserveDrawingBuffer)&&(i.clearColor(0,0,0,0),i.clear(i.DEPTH_BUFFER_BIT|i.COLOR_BUFFER_BIT)),e=this._width,t=this._height,e==this.canvas.width&&t==this.canvas.height||(this.canvas.style.width=this._width/this.scaleFactor+"px",this.canvas.style.height=this._height/this.scaleFactor+"px",this.canvas.width=this._width,this.canvas.height=this._height,i.viewport(0,0,this._width,this._height)),this.viewPoint&&this.viewPoint.glTFElement&&(this.viewPoint.glTFElement.cameras[0].projection.aspectRatio=this._width/this._height),null!=this._scene&&null!=this.viewPoint&&!this._disableRendering)){var n=(this.viewPoint,Date.now());if(this.interpolatingViewPoint){if(n-this.interpolatingViewPoint.start<this.interpolatingViewPoint.duration){if(this.orbitCamera){this.orbitCamera.ignoreEvents=!0;var r=(n-this.interpolatingViewPoint.start)/this.interpolatingViewPoint.duration;r=Utilities.easeOut(Math.min(r,1));var s=[0,0];Utilities.interpolateVec(this.interpolatingViewPoint.orbitXY,[0,0],r,s),this.orbitCamera.orbitX=s[0],this.orbitCamera.orbitY=s[1];var a=this.interpolatingViewPoint.orbitDistance;this.orbitCamera.setDistance(a+(0-a)*r),this.orbitCamera._dirty=!0}}else this.orbitCamera&&(this.orbitCamera.ignoreEvents=!1,this.orbitCamera.orbitX=0,this.orbitCamera.orbitY=0,this.orbitCamera.setDistance(0),this.interpolatingViewPoint=null);this.needsDraw=!0}if(this.sceneRenderer&&this.scene){var o=this.scene.glTFElement.animationManager;if(this._state==this.PLAY&&o){if(this._sceneTime+=n-this._lastTime,this.scene.glTFElement.duration!==-1&&this._sceneTime/1e3>this.scene.glTFElement.duration){if(1==this.automaticallyCycleThroughViewPoints){var h=this._viewPointIndex,l=this._getViewPoints(this.scene);if(l.length>0){var c,u=0;do this._sceneTime=0,u++,h=++h%l.length,c=l[h];while(u<l.length&&0==o.nodeHasAnimatedAncestor(c.glTFElement));this.viewPoint=c}}this.loops?this._sceneTime=this._sceneTime%this.scene.glTFElement.duration:this.stop()}this.scene.glTFElement.animationManager.updateTargetsAtTime(this._sceneTime,this.sceneRenderer.webGLRenderer.resourceManager)}}if(this._lastTime=n,this.orbitCamera){var d=this.orbitCamera.getViewMat();mat4.set(d,this.viewPointModifierMatrix),this.viewPoint&&null==this.viewPoint.glTFElement.parent&&mat4.inverse(this.viewPointModifierMatrix)}else if(this.flyingCamera){var d=this.flyingCamera.getViewMat();mat4.set(d,this.viewPointModifierMatrix),this.viewPoint&&null==this.viewPoint.glTFElement.parent&&mat4.inverse(this.viewPointModifierMatrix)}var m;if(this._state==this.PLAY&&(this.needsDraw=!0),this.scene&&(m=this.sceneRenderer.webGLRenderer,i)){if(this.showReflection&&this.orbitCamera){i.depthFunc(i.LESS),i.enable(i.DEPTH_TEST),i.frontFace(i.CW);var v=mat4.create(),g=this.scene.glTFElement.rootNode,w=g;mat4.set(g.transform.matrix,v),i.depthMask(!0);var _=mat4.translate(mat4.identity(),[0,0,0]),f=mat4.scale(_,[1,1,-1]);mat4.multiply(f,w.transform.matrix),g.transform.matrix=f,this.sceneRenderer.technique.rootPass.viewPoint.flipped=!0,this.sceneRenderer.render(n),i.depthMask(!0),this.sceneRenderer.technique.rootPass.viewPoint.flipped=!1,g.transform.matrix=v}null==this.__renderOptions&&(this.__renderOptions={}),this.__renderOptions.viewPointModifierMatrix=this.viewPointModifierMatrix,this.__renderOptions.interpolatingViewPoint=this.interpolatingViewPoint,this.__renderOptions.picking=!1,this.__renderOptions.coords=null,this.__renderOptions.delegate=null,this.sceneRenderer.render(n,this.__renderOptions),i.flush(),this._firstFrameDidRender===!1&&(this._firstFrameDidRender=!0,this.dispatchEventNamed("firstFrameDidRender",!0,!1,this))}}}}},willDraw:{value:function(){}},templateDidLoad:{value:function(){self=this,window.addEventListener("resize",this,!0);var e=(this.parentComponent,null),t=new TranslateComposer;t.animateMomentum=!0,t.hasMomentum=!0,t.allowFloats=!0,t.pointerSpeedMultiplier=.15,this.addComposerForElement(t,this.canvas),t.addPathChangeListener("translateY",function(e){self._consideringPointerForPicking=!1,self.needsDraw=!0}),t.addPathChangeListener("translateX",function(e){self._consideringPointerForPicking=!1,self.needsDraw=!0}),t.addEventListener("translateStart",function(t){e&&clearTimeout(e)},!1),t.addEventListener("translateEnd",function(){e=setTimeout(function(){self.needsDraw=!0},3e3)},!1),this.translateComposer=t}}});var MontageOrbitCamera=OrbitCamera;MontageOrbitCamera.prototype=Object.create(OrbitCamera.prototype);var MontageFlyingCamera=FlyingCamera;MontageFlyingCamera.prototype=Object.create(FlyingCamera.prototype),MontageOrbitCamera.prototype._hookEvents=function(e){var t=this,i=!1,n=0,r=0;this.translateComposer&&(this.translateComposer.addEventListener("translateStart",function(e){i=!0,n=e.translateX,r=e.translateY},!1),this.translateComposer.addEventListener("translate",function(e){if(i){var s=e.translateX-n,a=e.translateY-r;n=e.translateX,r=e.translateY,t.orbit(.013*s,.013*a)}},!1),this.translateComposer.addEventListener("translateEnd",function(){i=!1},!1),e.addEventListener("mousewheel",function(e){t.setDistance(-t._distance[2]+e.wheelDeltaY*t.distanceStep),e.preventDefault()},!1),e.addEventListener("gesturestart",function(e){t.initialDistance=t._distance[2],e.preventDefault()},!1),e.addEventListener("gesturechange",function(e){t.setDistance(-1*t.initialDistance/e.scale),e.preventDefault()},!1))};