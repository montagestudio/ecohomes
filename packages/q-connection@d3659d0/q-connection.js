function debug(){}function Connection(r,e,t){function n(){debug.apply(null,[y].concat(Array.prototype.slice.call(arguments)))}function o(e){n("receive:",e),Q.when(r.get(),o).done(),i(e)}function i(r){r=JSON.parse(r),n("receive: parsed message",r),d[r.type]&&l.has(r.to)&&d[r.type](r)}function a(r){if(l.has(r))return l.get(r).promise;var e=Q.defer();return l.set(r,e),e.promise}function u(r,e){n("resolve:","L"+JSON.stringify(r),JSON.stringify(e),typeof e),l.get(r).resolve(e)}function c(e){return Q.makePromise({when:function(){return this}},function(t,o){var i=p(),u=a(i);return n("sending:","R"+JSON.stringify(e),JSON.stringify(t),JSON.stringify(f(o))),r.put(JSON.stringify({type:"send",to:e,from:i,op:t,args:f(o)})),u})}function f(r){if(void 0===r)return{"%":"undefined"};if(Object(r)!==r)return r;if(Q.isPromise(r)||"function"==typeof r){var e=p();return a(e),u(e,r),{"@":e,type:typeof r}}if(r instanceof Error)return{message:r.message,stack:r.stack};if(Array.isArray(r))return r.map(f);if("object"==typeof r){var t={};for(var n in r)if(has.call(r,n)){var o=n.replace(/[@!%\\]/,function(r){return"\\"+r});t[o]=f(r[n])}return t}return r}function s(r){if(Object(r)!==r)return r;if(r["%"])return"undefined"===r["%"]?void 0:Q.reject(new TypeError("Unrecognized type: "+r["%"]));if(r["!"])return Q.reject(r["!"]);if(r["@"]){var e=c(r["@"]);return"function"===r.type?function(){return Q.fapply(e,Array.prototype.slice.call(arguments))}:e}if(Array.isArray(r))return r.map(s);var t={};for(var n in r)if(has.call(r,n)){var o=n.replace(/\\([\\!@%])/,function(r,e){return e});t[o]=s(r[n])}return t}t=t||{};var p=t.makeId||function(){return UUID.generate()},l=LruMap(null,t.max||1/0);r=adapt(r,t.origin);var y=Math.random().toString(16).slice(2,4).toUpperCase()+":";Q.when(r.get(),o).done();var d={resolve:function(r){l.has(r.to)&&u(r.to,s(r.resolution))},send:function(e){var t=l.get(e.to).promise,n=Q.dispatch(t,e.op,s(e.args));Q.when(n,function(t){try{t=f(t)}catch(n){try{t={"!":f(n)}}catch(n){t={"!":null}}}var o=JSON.stringify({type:"resolve",to:e.from,resolution:t});r.put(o)},function(t){try{t=f(t)}catch(n){try{t=f(n)}catch(n){t=null}}envelope=JSON.stringify({type:"resolve",to:e.from,resolution:{"!":t}}),r.put(envelope)}).done()}};return a(rootId),u(rootId,e),c(rootId)}var Q=require("q"),LruMap=require("collections/lru-map"),UUID=require("./lib/uuid"),adapt=require("./adapt"),rootId="",has=Object.prototype.hasOwnProperty;module.exports=Connection;