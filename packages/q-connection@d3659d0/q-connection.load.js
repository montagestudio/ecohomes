montageDefine("d3659d0","q-connection",{dependencies:["q","collections/lru-map","./lib/uuid","./adapt"],factory:function(e,r,t){function n(){}function i(e,r,t){function i(){n.apply(null,[S].concat(Array.prototype.slice.call(arguments)))}function p(r){i("receive:",r),o.when(e.get(),p).done(),l(r)}function l(e){e=JSON.parse(e),i("receive: parsed message",e),J[e.type]&&O.has(e.to)&&J[e.type](e)}function y(e){if(O.has(e))return O.get(e).promise;var r=o.defer();return O.set(e,r),r.promise}function v(e,r){i("resolve:","L"+JSON.stringify(e),JSON.stringify(r),typeof r),O.get(e).resolve(r)}function d(r){return o.makePromise({when:function(){return this}},function(t,n){var o=h(),a=y(o);return i("sending:","R"+JSON.stringify(r),JSON.stringify(t),JSON.stringify(g(n))),e.put(JSON.stringify({type:"send",to:r,from:o,op:t,args:g(n)})),a})}function g(e){if(void 0===e)return{"%":"undefined"};if(Object(e)!==e)return e;if(o.isPromise(e)||"function"==typeof e){var r=h();return y(r),v(r,e),{"@":r,type:typeof e}}if(e instanceof Error)return{message:e.message,stack:e.stack};if(Array.isArray(e))return e.map(g);if("object"==typeof e){var t={};for(var n in e)if(s.call(e,n)){var i=n.replace(/[@!%\\]/,function(e){return"\\"+e});t[i]=g(e[n])}return t}return e}function m(e){if(Object(e)!==e)return e;if(e["%"])return"undefined"===e["%"]?void 0:o.reject(new TypeError("Unrecognized type: "+e["%"]));if(e["!"])return o.reject(e["!"]);if(e["@"]){var r=d(e["@"]);return"function"===e.type?function(){return o.fapply(r,Array.prototype.slice.call(arguments))}:r}if(Array.isArray(e))return e.map(m);var t={};for(var n in e)if(s.call(e,n)){var i=n.replace(/\\([\\!@%])/,function(e,r){return r});t[i]=m(e[n])}return t}t=t||{};var h=t.makeId||function(){return u.generate()},O=a(null,t.max||1/0);e=c(e,t.origin);var S=Math.random().toString(16).slice(2,4).toUpperCase()+":";o.when(e.get(),p).done();var J={resolve:function(e){O.has(e.to)&&v(e.to,m(e.resolution))},send:function(r){var t=O.get(r.to).promise,n=o.dispatch(t,r.op,m(r.args));o.when(n,function(t){try{t=g(t)}catch(n){try{t={"!":g(n)}}catch(n){t={"!":null}}}var i=JSON.stringify({type:"resolve",to:r.from,resolution:t});e.put(i)},function(t){try{t=g(t)}catch(n){try{t=g(n)}catch(n){t=null}}envelope=JSON.stringify({type:"resolve",to:r.from,resolution:{"!":t}}),e.put(envelope)}).done()}};return y(f),v(f,r),d(f)}var o=e("q"),a=e("collections/lru-map"),u=e("./lib/uuid"),c=e("./adapt"),f="",s=Object.prototype.hasOwnProperty;t.exports=i}});