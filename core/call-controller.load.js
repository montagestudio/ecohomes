montageDefine("22a41ee","core/call-controller",{dependencies:["montage","montage/core/promise","montage/core/state-chart","montage/core/state-chart","q-connection","q-connection/adapt"],factory:function(e,t,n){var a=e("montage").Montage,r=e("montage/core/promise").Promise,o=e("montage/core/state-chart").StateChart,l=e("montage/core/state-chart").State,i=e("q-connection"),c=e("q-connection/adapt");t.CallController=a.specialize({constructor:{value:function(){var e,t,n,a,r,i=this;t=(new l).init({call:function(e,t,n){this.gotoState("callingNow")},later:function(e,t,n){this.gotoState("callLater")}}),a=(new l).init({enterState:function(){i.callStatus="",i.makeContactCall().caught(function(){i.errors.push({message:"A server error has occured"})})},cancel:function(e,t,n){i.cancelCall(),this.gotoState("callNow")},end:function(e,t,n){this.gotoState("callNow")}}),n=(new l).init({call:function(e,t,n){this.gotoState("callingLater")},now:function(e,t,n){this.gotoState("callNow")}}),r=(new l).init({cancel:function(e,t,n){this.gotoState("callNow")}}),e=(new l).init({initialSubstate:"callNow",callNow:t,callingNow:a,callLater:n,callingLater:r}),this._stateChart=(new o).initWithState(e),this._stateChart.delegate=this,this.errors=[],this.defineBinding("currentState",{"<-":"_stateChart.currentState.name"})}},server:{value:null},_stateChart:{value:null},stateChartWillGoFromStateToState:{value:function(e,t,n){this.callDelegateMethod("stateDidChange",this,n.name)}},stateChartShouldGoFromStateToState:{value:function(e,t,n){return this.clearErrors(),!("callingNow"===n.name&&!this.validatePhoneNumber())||(this.errors.push({message:"Phone number not valid"}),!1)}},call:{value:function(){this._stateChart.performAction("call")}},later:{value:function(){this._stateChart.performAction("later")}},cancel:{value:function(){this._stateChart.performAction("cancel")}},callEnded:{value:function(){this._stateChart.performAction("end")}},_currentCall:{value:null},makeContactCall:{value:function(){var e=this;return this.backend.get("calls").invoke("makeCall",this._normalizedPhoneNumber,function(e){this.callStatus=e}.bind(this),function(){this.callEnded()}.bind(this)).then(function(t){e._currentCall=t})}},cancelCall:{value:function(){return this._currentCall?this._currentCall.invoke("cancel"):r.reject()}},_post:{value:function(e,t,n){var a,o=r.defer(),l=new XMLHttpRequest;return l.open("POST",e,!0),l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(a&&clearTimeout(a),o.resolve(l.responseText)):o.reject("HTTP "+l.status+" for "+e))},n&&(a=setTimeout(o.reject,n)),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(t.join("&")),o.promise}},clearErrors:{value:function(){this.errors.clear()}},_phoneNumberRegex:{value:/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/},validatePhoneNumber:{value:function(){return null!=this.phoneNumber&&this._phoneNumberRegex.test(this.phoneNumber)?(this._normalizedPhoneNumber=this.phoneNumber.replace(this._phoneNumberRegex,"$1$2$3"),!0):null!=this.phoneNumber&&this._phoneNumberRegex.test(this.phoneNumber)}},errors:{value:null},phoneNumber:{value:null},callStatus:{value:""},_normalizedPhoneNumber:{value:null},identifier:{value:"callController"},alive:{value:function(){if(null===this.server)return r.resolve();var e,t=500,n=new XMLHttpRequest,a="http://"+this.server+"/alive",o=new r(function(r,o){n.open("GET",a,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(e&&clearTimeout(e),r(n.responseText)):o(new Error("HTTP "+n.status+" for "+a)))},e=setTimeout(o,t-50)});return n.send(),o.timeout(t)}},_backend:{value:null},backend:{get:function(){if(null==this._backend){var e=c(new WebSocket("ws://"+this.server));e.closed.then(function(){this._backend=null}),this._backend=i(e)}return this._backend}}})}});