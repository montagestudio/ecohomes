var Montage=require("montage").Montage,Promise=require("montage/core/promise").Promise,StateChart=require("montage/core/state-chart").StateChart,State=require("montage/core/state-chart").State,Connection=require("q-connection"),adaptConnection=require("q-connection/adapt");exports.CallController=Montage.specialize({constructor:{value:function(){var e,t,n,a,r,o=this;t=(new State).init({call:function(e,t,n){this.gotoState("callingNow")},later:function(e,t,n){this.gotoState("callLater")}}),a=(new State).init({enterState:function(){o.callStatus="",o.makeContactCall().caught(function(){o.errors.push({message:"A server error has occured"})})},cancel:function(e,t,n){o.cancelCall(),this.gotoState("callNow")},end:function(e,t,n){this.gotoState("callNow")}}),n=(new State).init({call:function(e,t,n){this.gotoState("callingLater")},now:function(e,t,n){this.gotoState("callNow")}}),r=(new State).init({cancel:function(e,t,n){this.gotoState("callNow")}}),e=(new State).init({initialSubstate:"callNow",callNow:t,callingNow:a,callLater:n,callingLater:r}),this._stateChart=(new StateChart).initWithState(e),this._stateChart.delegate=this,this.errors=[],this.defineBinding("currentState",{"<-":"_stateChart.currentState.name"})}},server:{value:null},_stateChart:{value:null},stateChartWillGoFromStateToState:{value:function(e,t,n){this.callDelegateMethod("stateDidChange",this,n.name)}},stateChartShouldGoFromStateToState:{value:function(e,t,n){return this.clearErrors(),!("callingNow"===n.name&&!this.validatePhoneNumber())||(this.errors.push({message:"Phone number not valid"}),!1)}},call:{value:function(){this._stateChart.performAction("call")}},later:{value:function(){this._stateChart.performAction("later")}},cancel:{value:function(){this._stateChart.performAction("cancel")}},callEnded:{value:function(){this._stateChart.performAction("end")}},_currentCall:{value:null},makeContactCall:{value:function(){var e=this;return this.backend.get("calls").invoke("makeCall",this._normalizedPhoneNumber,function(e){this.callStatus=e}.bind(this),function(){this.callEnded()}.bind(this)).then(function(t){e._currentCall=t})}},cancelCall:{value:function(){return this._currentCall?this._currentCall.invoke("cancel"):Promise.reject()}},_post:{value:function(e,t,n){var a,r=Promise.defer(),o=new XMLHttpRequest;return o.open("POST",e,!0),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?(a&&clearTimeout(a),r.resolve(o.responseText)):r.reject("HTTP "+o.status+" for "+e))},n&&(a=setTimeout(r.reject,n)),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(t.join("&")),r.promise}},clearErrors:{value:function(){this.errors.clear()}},_phoneNumberRegex:{value:/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/},validatePhoneNumber:{value:function(){return null!=this.phoneNumber&&this._phoneNumberRegex.test(this.phoneNumber)?(this._normalizedPhoneNumber=this.phoneNumber.replace(this._phoneNumberRegex,"$1$2$3"),!0):null!=this.phoneNumber&&this._phoneNumberRegex.test(this.phoneNumber)}},errors:{value:null},phoneNumber:{value:null},callStatus:{value:""},_normalizedPhoneNumber:{value:null},identifier:{value:"callController"},alive:{value:function(){if(null===this.server)return Promise.resolve();var e,t=500,n=new XMLHttpRequest,a="http://"+this.server+"/alive",r=new Promise(function(r,o){n.open("GET",a,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(e&&clearTimeout(e),r(n.responseText)):o(new Error("HTTP "+n.status+" for "+a)))},e=setTimeout(o,t-50)});return n.send(),r.timeout(t)}},_backend:{value:null},backend:{get:function(){if(null==this._backend){var e=adaptConnection(new WebSocket("ws://"+this.server));e.closed.then(function(){this._backend=null}),this._backend=Connection(e)}return this._backend}}});